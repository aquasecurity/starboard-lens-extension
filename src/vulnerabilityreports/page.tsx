import {Renderer} from "@k8slens/extensions";
import React from "react";
import {ClusterVulnerabilityReport, VulnerabilityReport} from "./types";
import {clusterStore, store} from "./store";
import {Scanner} from "../starboard/types";

const {
    Component: {
        KubeObjectListLayout,
        Badge,
    }
} = Renderer;

enum sortBy {
    name = "name",
    namespace = "namespace",
    critical = "critical",
    high = "high",
    medium = "medium",
    low = "low",
    unknown = "unknown",
}

export class ClusterVulnerabilityReportPage extends React.Component<{ extension: Renderer.LensExtension }> {

    render() {
        return (
            <KubeObjectListLayout
                tableId="clusterVulnerabilityReportsTable"
                className="ClusterVulnerabilityReports" store={clusterStore}
                sortingCallbacks={{
                    [sortBy.name]: (report: ClusterVulnerabilityReport) => report.getName(),
                    [sortBy.critical]: (report: ClusterVulnerabilityReport) => report.report.summary.criticalCount,
                    [sortBy.high]: (report: ClusterVulnerabilityReport) => report.report.summary.highCount,
                    [sortBy.medium]: (report: ClusterVulnerabilityReport) => report.report.summary.mediumCount,
                    [sortBy.low]: (report: ClusterVulnerabilityReport) => report.report.summary.lowCount,
                    [sortBy.unknown]: (report: ClusterVulnerabilityReport) => report.report.summary.unknownCount,
                }}
                searchFilters={[
                    (report: ClusterVulnerabilityReport) => report.getSearchFields()
                ]}
                renderHeaderTitle="ClusterVulnerabilityReports"
                renderTableHeader={[
                    {title: "Name", className: "name", sortBy: sortBy.name},
                    {title: "Image", className: "repository"},
                    {title: "Critical", className: "critical", sortBy: sortBy.critical},
                    {title: "High", className: "high", sortBy: sortBy.high},
                    {title: "Medium", className: "medium", sortBy: sortBy.medium},
                    {title: "Low", className: "low", sortBy: sortBy.low},
                    {title: "Unknown", sortBy: sortBy.unknown},
                    {title: "Scanner", className: "scanner"},
                ]}
                renderTableContents={(report: ClusterVulnerabilityReport) => [
                    renderName(report.getName()),
                    renderImage(report),
                    report.report.summary.criticalCount,
                    report.report.summary.highCount,
                    report.report.summary.mediumCount,
                    report.report.summary.lowCount,
                    report.report.summary.unknownCount,
                    renderScanner(report.report.scanner),
                ]}
            />
        )
    }
}


export class VulnerabilityReportPage extends React.Component<{ extension: Renderer.LensExtension }> {

    render() {
        return (
            <KubeObjectListLayout
                tableId="vulnerabilityReportsTable"
                className="VulnerabilityReports" store={store}
                sortingCallbacks={{
                    [sortBy.name]: (report: VulnerabilityReport) => report.getName(),
                    [sortBy.namespace]: (report: VulnerabilityReport) => report.metadata.namespace,
                    [sortBy.critical]: (report: VulnerabilityReport) => report.report.summary.criticalCount,
                    [sortBy.high]: (report: VulnerabilityReport) => report.report.summary.highCount,
                    [sortBy.medium]: (report: VulnerabilityReport) => report.report.summary.mediumCount,
                    [sortBy.low]: (report: VulnerabilityReport) => report.report.summary.lowCount,
                    [sortBy.unknown]: (report: VulnerabilityReport) => report.report.summary.unknownCount,
                }}
                searchFilters={[
                    (report: VulnerabilityReport) => report.getSearchFields()
                ]}
                renderHeaderTitle="VulnerabilityReports"
                renderTableHeader={[
                    {title: "Name", className: "name", sortBy: sortBy.name},
                    {title: "Namespace", className: "namespace", sortBy: sortBy.namespace},
                    {title: "Image", className: "repository"},
                    {title: "Critical", className: "critical", sortBy: sortBy.critical},
                    {title: "High", className: "high", sortBy: sortBy.high},
                    {title: "Medium", className: "medium", sortBy: sortBy.medium},
                    {title: "Low", className: "low", sortBy: sortBy.low},
                    {title: "Unknown", sortBy: sortBy.unknown},
                    {title: "Scanner", className: "scanner"},
                ]}
                renderTableContents={(report: VulnerabilityReport) => [
                    renderName(report.getName()),
                    report.metadata.namespace,
                    renderImage(report),
                    report.report.summary.criticalCount,
                    report.report.summary.highCount,
                    report.report.summary.mediumCount,
                    report.report.summary.lowCount,
                    report.report.summary.unknownCount,
                    renderScanner(report.report.scanner),
                ]}
            />
        )
    }
}

function renderName(name: string) {
    return (
        <Badge flat expandable={false} key="name" label={name} tooltip={name}/>
    )
}

function renderScanner(scanner: Scanner) {
    return scanner.name + " " + scanner.version
}

function renderImage(report: VulnerabilityReport) {
    const imageRef = report.getImageRef()
    return (
        <Badge flat expandable={false} key="imageRef" label={imageRef} tooltip={imageRef}/>
    )
}
