import {Renderer} from "@k8slens/extensions";
import React from "react";
import {Vulnerability, VulnerabilityReport} from "../vulnerability-report";
import {VulnerabilitiesList} from "./vulnerabilities-list";

export interface VulnerabilityReportDetailsProps extends Renderer.Component.KubeObjectDetailsProps<VulnerabilityReport> {

    /*
     * Determines whether to display container name with a little rectangle.
     * If the rectangle is green there are no action. If it's red it means
     * that there are some critical or high vulnerabilities and it's a good
     * idea to check them out.
     */
    showContainerStatus?: boolean

    /*
     * Determines whether to display ObjectMeta section or not.
     * We want to display it in the generic VulnerabilityReport view.
     * However, we want to hide it when we list VulnerabilityReports
     * in the WorkloadVulnerabilities details pane.
     */
    showObjectMeta?: boolean
}

const DANGER_STATUSES = ['CRITICAL', 'HIGH'];

export class VulnerabilityReportDetails extends React.Component<VulnerabilityReportDetailsProps> {

    render() {
        const {object: report} = this.props;
        const { report: { vulnerabilities: items } } = report;

        const hasSomeProblem = items.some(vulnerability => DANGER_STATUSES.includes(vulnerability.severity));
        const vulnerabilities = items.map((vulnerability) => new Vulnerability(vulnerability))
        if (!report) return null;
        return (
            <div className="PodDetailsContainer">
                {this.props.showContainerStatus &&
                <div className="pod-container-title">
                    <Renderer.Component.StatusBrick
                        className={hasSomeProblem ? 'error' : 'succeeded'}/>{report.metadata.labels['starboard.container.name']}
                </div>}

                {this.props.showObjectMeta &&
                <Renderer.Component.KubeObjectMeta object={report}
                                          hideFields={["uid", "resourceVersion", "selfLink"]}/>}

                <Renderer.Component.DrawerItem name="Image">
                    {"" + report.getImageRef()}
                </Renderer.Component.DrawerItem>

                <Renderer.Component.DrawerItem name="Critical">
                    {report.report.summary.criticalCount}
                </Renderer.Component.DrawerItem>
                <Renderer.Component.DrawerItem name="High">
                    {report.report.summary.highCount}
                </Renderer.Component.DrawerItem>
                <Renderer.Component.DrawerItem name="Medium">
                    {report.report.summary.mediumCount}
                </Renderer.Component.DrawerItem>
                <Renderer.Component.DrawerItem name="Low">
                    {report.report.summary.lowCount}
                </Renderer.Component.DrawerItem>
                <Renderer.Component.DrawerItem name="Unknown">
                    {report.report.summary.unknownCount}
                </Renderer.Component.DrawerItem>

                <Renderer.Component.DrawerTitle title={"Vulnerabilities"}/>
                <VulnerabilitiesList vulnerabilities={vulnerabilities}/>
            </div>
        )
    }
}
